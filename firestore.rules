rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserTenantId() {
      return request.auth.token.tenantId;
    }

    function hasCustomClaims() {
      return request.auth.token.tenantId != null;
    }

    function isTenantMember(tenantId) {
      return isAuthenticated() &&
             (hasCustomClaims() ? getUserTenantId() == tenantId : true);
    }

    function isTenantOwner(tenantId) {
      return isAuthenticated() &&
             (hasCustomClaims()
               ? (getUserTenantId() == tenantId && request.auth.token.role == 'owner')
               : get(/databases/$(database)/documents/tenants/$(tenantId)).data.owner_id == request.auth.uid);
    }

    function hasRole(role) {
      return isAuthenticated() && request.auth.token.role == role;
    }

    // --- Guest Access Helper Functions ---
    // Note: Guest READ access is now handled via Cloud Function (guestAccessOps)
    // These helpers are only for CREATE operations
    
    function isValidGuestToken(token, groupId) {
      let group = get(/databases/$(database)/documents/groups/$(groupId));
      return group.data.guest_access_token == token && 
             group.data.is_guest_access_enabled == true;
    }

    function hasValidGuestTokenForBirthday(birthdayData) {
      // CRITICAL SECURITY CHECKS for guest-created birthdays:
      // 1. Verify group_ids array exists and has at least one group
      // 2. Verify guest_token_used is present
      // 3. Verify token matches the group's guest_access_token
      // 4. **TENANT INJECTION PREVENTION**: Verify tenant_id matches the group's tenant_id
      //    This prevents guests from injecting a different tenant_id to bypass security
      return birthdayData.group_ids != null && 
             birthdayData.group_ids.size() > 0 &&
             birthdayData.guest_token_used != null &&
             isValidGuestToken(birthdayData.guest_token_used, birthdayData.group_ids[0]) &&
             birthdayData.tenant_id == get(/databases/$(database)/documents/groups/$(birthdayData.group_ids[0])).data.tenant_id;
    }

    // --- Existing Collections ---

    match /profiles/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && request.auth.uid == userId;
      allow delete: if false;
    }

    match /tenants/{tenantId} {
      allow read: if isTenantMember(tenantId);
      allow create: if isAuthenticated() && request.resource.data.owner_id == request.auth.uid;
      allow update: if isTenantOwner(tenantId);
      allow delete: if isTenantOwner(tenantId);
    }

    match /tenant_members/{membershipId} {
      allow read: if isAuthenticated() &&
                     resource != null &&
                     (request.auth.uid == resource.data.user_id ||
                      isTenantMember(resource.data.tenant_id));
      allow create: if isAuthenticated() 
                    && request.auth.uid == request.resource.data.user_id
                    && get(/databases/$(database)/documents/tenants/$(request.resource.data.tenant_id)).data.owner_id == request.auth.uid;
      allow update, delete: if isAuthenticated() && 
                               resource != null &&
                               request.auth.uid == resource.data.user_id;
    }

    match /groups/{groupId} {
      // Only authenticated users can read groups
      // Guests access group data via Cloud Function (guestAccessOps)
      allow read: if isAuthenticated() && 
                      resource != null &&
                      isTenantMember(resource.data.tenant_id);
                     
      allow create: if isAuthenticated() &&
                       (hasCustomClaims() ? request.resource.data.tenant_id == getUserTenantId() : true);
                       
      // Split Update and Delete
      allow update: if isAuthenticated() &&
                       resource != null &&
                       isTenantMember(resource.data.tenant_id) &&
                       resource.data.tenant_id == request.resource.data.tenant_id; // Prevent tenant_id change
                       
      allow delete: if isAuthenticated() &&
                       resource != null &&
                       isTenantMember(resource.data.tenant_id);
    }

    match /birthdays/{birthdayId} {
      // Authenticated users can read all birthdays in their tenant
      // Guests access birthdays via Cloud Function (guestAccessOps)
      allow read: if isAuthenticated() && 
                      resource != null &&
                      isTenantMember(resource.data.tenant_id);
      
      // Authenticated users can create birthdays in their tenant
      // Unauthenticated guests can create birthdays with valid token AND matching tenant_id
      allow create: if (isAuthenticated() &&
                        (hasCustomClaims() ? request.resource.data.tenant_id == getUserTenantId() : true)) ||
                       (!isAuthenticated() && 
                        request.resource.data.created_by_guest == true &&
                        request.resource.data.guest_token_used != null &&
                        request.resource.data.group_ids != null &&
                        request.resource.data.group_ids.size() > 0 &&
                        hasValidGuestTokenForBirthday(request.resource.data));
                       
      // Split Update and Delete - only for authenticated users
      allow update: if isAuthenticated() &&
                       resource != null &&
                       isTenantMember(resource.data.tenant_id) &&
                       resource.data.tenant_id == request.resource.data.tenant_id; // Prevent tenant_id change
                       
      allow delete: if isAuthenticated() &&
                       resource != null &&
                       isTenantMember(resource.data.tenant_id);
    }

    match /wishlist_items/{itemId} {
      allow read: if isAuthenticated() && 
                     resource != null &&
                     isTenantMember(resource.data.tenant_id);
      allow create: if isAuthenticated() &&
                       (hasCustomClaims() ? request.resource.data.tenant_id == getUserTenantId() : true);
                       
      // Split Update and Delete
      allow update: if isAuthenticated() &&
                       resource != null &&
                       isTenantMember(resource.data.tenant_id) &&
                       resource.data.tenant_id == request.resource.data.tenant_id; // Prevent tenant_id change
                       
      allow delete: if isAuthenticated() &&
                       resource != null &&
                       isTenantMember(resource.data.tenant_id);
    }

    // --- Gelt Calculations (Secured Version) ---
    match /gelt_calculations/{calculationId} {
      allow read: if isAuthenticated() && 
                     resource != null && 
                     isTenantMember(resource.data.tenant_id);
      
      allow create: if isAuthenticated() &&
                       request.resource.data.tenant_id != null &&
                       (hasCustomClaims() 
                         ? request.resource.data.tenant_id == getUserTenantId() 
                         : true);
      
      allow update: if isAuthenticated() &&
                       resource != null &&
                       isTenantMember(resource.data.tenant_id) &&
                       resource.data.tenant_id == request.resource.data.tenant_id;
      
      allow delete: if isAuthenticated() &&
                       resource != null &&
                       isTenantMember(resource.data.tenant_id);
    }

    // --- NEW: Gelt States ---
    match /gelt_states/{stateId} {
      // Read: stateId is the tenant_id, so check if user is member of that tenant
      allow read: if isAuthenticated() && isTenantMember(stateId);
      
      // Create/Update: stateId should match tenant_id, and user should be tenant member
      allow create, update: if isAuthenticated() &&
                              (hasCustomClaims() 
                                ? (request.resource.data.tenant_id == getUserTenantId() && stateId == getUserTenantId())
                                : (request.resource.data.tenant_id == stateId && isTenantMember(stateId)));
      
      // Delete: allow if user is tenant member
      allow delete: if isAuthenticated() && isTenantMember(stateId);
    }

    // --- GELT Templates ---
    match /gelt_templates/{templateId} {
      // Read: רק חברי tenant יכולים לקרוא תבניות של אותו tenant
      // לשאילתות (queries) - Firestore בודק את ה-rule עבור כל מסמך שיחזר מה-query
      // למסמכים בודדים - נבדוק ב-resource
      // חשוב: ה-query חייב לכלול where('tenant_id', '==', tenantId) כדי שהכלל יעבוד
      // ב-queries, resource הוא null, אז נאפשר קריאה אם המשתמש מאומת
      // ה-where clause יבטיח שרק תבניות של אותו tenant יוחזרו
      // למסמכים בודדים, נבדוק את ה-tenant_id של המסמך
      // הפתרון: לאפשר קריאה אם המשתמש מאומת, ולבדוק את ה-tenant_id של המסמך אם הוא קיים
      // ב-queries, resource הוא null, אז נאפשר קריאה אם המשתמש מאומת
      // למסמכים בודדים, נבדוק את ה-tenant_id של המסמך
      // אם יש custom claims, נבדוק שהמשתמש הוא חבר ב-tenant של המסמך
      allow read: if isAuthenticated() && 
                     (resource == null || 
                      (resource != null && 
                       resource.data != null && 
                       resource.data.tenant_id != null && 
                       (hasCustomClaims() 
                         ? (getUserTenantId() == resource.data.tenant_id)
                         : isTenantMember(resource.data.tenant_id))));
      
      // Create: רק חברי tenant יכולים ליצור תבניות
      allow create: if isAuthenticated() &&
                       request.resource.data.tenant_id != null &&
                       isTenantMember(request.resource.data.tenant_id) &&
                       request.resource.data.created_by == request.auth.uid &&
                       request.resource.data.updated_by == request.auth.uid;
      
      // Update: רק חברי tenant יכולים לעדכן תבניות
      allow update: if isAuthenticated() &&
                       resource != null &&
                       resource.data != null &&
                       resource.data.tenant_id != null &&
                       isTenantMember(resource.data.tenant_id) &&
                       request.resource.data.tenant_id == resource.data.tenant_id &&
                       request.resource.data.updated_by == request.auth.uid;
      
      // Delete: רק חברי tenant יכולים למחוק תבניות
      allow delete: if isAuthenticated() &&
                      resource != null &&
                      resource.data != null &&
                      resource.data.tenant_id != null &&
                      isTenantMember(resource.data.tenant_id);
    }

    // --- System & Rate Limits ---

    match /rate_limits/{docId} {
      allow read, write: if false;
    }

    match /googleCalendarTokens/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
      allow create: if isAuthenticated() && request.auth.uid == userId &&
                       request.resource.data.userId == userId;
    }
  }
}